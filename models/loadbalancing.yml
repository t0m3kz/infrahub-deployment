# yaml-language-server: $schema=https://schema.infrahub.app/infrahub/schema/latest.json
---
version: "1.0"
generics:
  - name: PolicyAssignment
    namespace: Loadbalancing
    label: Loadbalancing Policy
    include_in_menu: false
    relationships:
      - name: rules
        label: Policy
        peer: LoadbalancingRenderedPolicyRule
        kind: Component
        cardinality: many
        optional: true
  - name: GenericServiceGroup
    namespace: Loadbalancing
    include_in_menu: false
    hierarchical: true
    display_labels:
      - name__value
    attributes:
      - name: name
        label: Name
        kind: Text
        optional: false
      - name: description
        label: Description
        kind: Text
        optional: true
    relationships:
      - name: services
        peer: LoadbalancingGenericService
        label: Services
        cardinality: many
        kind: Component
        optional: true
  - name: GenericService
    include_in_menu: false
    namespace: Loadbalancing
    display_labels:
      - name__value
    attributes:
      - name: name
        label: Name
        kind: Text
        optional: false
      - name: description
        kind: Text
        label: Description
        optional: true
    relationships:
      - name: service_groups
        label: Service Groups
        peer: LoadbalancingGenericServiceGroup
        cardinality: many
        optional: true

nodes:
  - name: VIPIPAddress
    namespace: Loadbalancing
    menu_placement: LoadbalancingPolicy
    include_in_menu: true
    icon: "mdi:ip-outline"
    description: "Infrahub IPv4/6 address"
    label: "VIP IP Address"
    default_filter: name__value
    inherit_from:
      - SecurityGenericAddress
    attributes:
      - name: description
        kind: Text
        optional: true
    relationships:
      - name: ip_address
        peer: InfraIPAddress
        cardinality: one
        kind: Attribute
        optional: false

  - name: Loadbalancer
    namespace: Security
    inherit_from:
      - InfraGenericDevice
      - CoreArtifactTarget
      - SecurityPolicyAssignment
    icon: "mdi:firewall"
    include_in_menu: true
    default_filter: name__value
    menu_placement: "InfraGenericDevice"
    attributes:
      - name: role
        kind: Dropdown
        optional: true
        choices:
          - name: edge_firewall
            label: Edge firewall
            description: "Security boundary with external network"
            color: "#6a5acd"
    relationships:
      - name: policy
        peer: SecurityPolicy
        label: Security Policy
        cardinality: one
        kind: Attribute
  - name: RenderedPolicyRule
    namespace: Security
    include_in_menu: false
    label: Policy rule
    description: "Policy rule"
    order_by:
      - source_zone__name__value
      - destination_zone__name__value
      - index__value
    attributes:
      - name: index
        label: Index
        kind: Number
        optional: false
        order_weight: 99999
      - name: name
        label: Name
        kind: Text
        optional: false
      - name: action
        label: Action
        kind: Text
        enum: ["permit", "deny"]
        default_value: permit
        optional: false
      - name: log
        label: Log
        kind: Boolean
        default_value: false
        optional: true
        order_weight: 99998
    relationships:
      - name: source_policy
        peer: SecurityPolicy
        kind: Attribute
        cardinality: one
        optional: false
      - name: source_zone
        peer: SecurityZone
        kind: Attribute
        cardinality: one
        optional: false
        identifier: rendered_policy_rule__source_zone
        order_weight: 1
      - name: destination_zone
        peer: SecurityZone
        kind: Attribute
        cardinality: one
        optional: false
        identifier: rendered_policy_rule__destination_zone
        order_weight: 2
      - name: source_address
        peer: SecurityGenericAddress
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__source_address
      - name: source_groups
        peer: SecurityGenericAddressGroup
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__source_address_group
      - name: source_services
        peer: SecurityGenericService
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__source_service
      - name: source_service_groups
        peer: SecurityGenericServiceGroup
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__source_service_group
      - name: destination_address
        peer: SecurityGenericAddress
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__destination_address
      - name: destination_groups
        peer: SecurityGenericAddressGroup
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__destination_address_group
      - name: destination_services
        peer: SecurityGenericService
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__destination_service
      - name: destination_service_groups
        peer: SecurityGenericServiceGroup
        optional: true
        kind: Attribute
        cardinality: many
        identifier: rendered_policy_rule__destination_service_group
  - name: FirewallInterface
    namespace: Security
    label: Firewall Interface
    menu_placement: "InfraGenericDevice"
    include_in_menu: false
    icon: "mdi:ethernet"
    display_labels:
      - name__value
    inherit_from:
      - InfraInterface
      - InfraEndpoint
    relationships:
      - name: ip_addresses
        peer: InfraIPAddress
        optional: true
        cardinality: many
        kind: Component
      - name: security_zone
        peer: SecurityZone
        optional: false
        cardinality: one
        kind: Attribute
extensions:
  nodes:
    - kind: LocationGeneric
      relationships:
        - name: policy
          peer: SecurityPolicy
          cardinality: one
          kind: Attribute
